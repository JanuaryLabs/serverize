---
import '@/styles/globals.css';

import { basename, extname } from 'path';
import type { MarkdownInstance } from 'astro';
import TreeNode from '../components/TreeNode.astro';
import { Nav } from '../components/background';
import Main from './main.astro';

const posts = Object.values(
  import.meta.glob(
    ['../pages/docs/**/!(_)*.{md,mdx}', '!../pages/docs/**/_*/**'],
    { eager: true },
  ),
) as MarkdownInstance<{ title: string; subtitle: string }>[];

function createObject(
  obj: Record<string, any>,
  keys: string[],
  value: any = null,
): Record<string, any> {
  let current = obj;

  for (let i = 0; i < keys.length; i++) {
    const key = keys[i];

    if (i === keys.length - 1) {
      // Last key in the chain
      if (!current[key]) {
        current[key] = { ...value, children: {} };
      } else {
        current[key] = {
          ...current[key],
          ...value,
        };
      }
    } else {
      // Intermediate keys
      current[key] = current[key] || { children: {} };
      current = current[key].children;
    }
  }

  return obj;
}

const groups = {};
for (const post of posts) {
  const dot = post
    .url!.split('/')
    .slice(2)
    .map((it) => it.replaceAll(/-/g, ' ').replace(/^\d./, ''));
  createObject(groups, dot, extractProps(post));
}

function extractProps(
  post: MarkdownInstance<{ title: string; subtitle: string }>,
) {
  return {
    name: basename(post.file)
      .replace(extname(post.file), '')
      .replace(/^\d\./g, ''),
    title: post.frontmatter.title,
    subtitle: post.frontmatter.subtitle,
    href: post
      .url!.replaceAll(/\d\./g, '')
      .replaceAll(/\s/g, '-')
      .toLowerCase(),
    headings: post.getHeadings().map((it) => ({
      ...it,
      slug: `#${it.slug}`,
    })),
  };
}

const { frontmatter, url } = Astro.props;
const canonical = Astro.site && url ? new URL(url, Astro.site).pathname : '';
const dashes = '-'.repeat(1000);
---

<Main title={frontmatter.title} canonical={canonical}>
  <Nav client:load className="border-b" />
  <div
    class="mx-auto mt-16 grid max-w-[1400px] grid-cols-1 gap-4 gap-x-12 px-6 md:grid-cols-[240px_minmax(0,2fr)] md:gap-x-8 lg:grid-cols-[240px_minmax(0,1fr)_240px] lg:gap-x-4 xl:gap-x-12 2xl:px-0"
  >
    <aside
      class="sticky top-16 hidden h-[calc(100vh-4rem)] overflow-y-auto border-r md:block lg:block"
    >
      <TreeNode tree={groups} />
    </aside>

    <article class="prose max-w-full pb-16">
      <p class="invisible h-0">{dashes}</p>
      <h1 class="mb-0 text-4xl font-bold">{frontmatter.title}</h1>
      <!-- <p class="text-secondary-foreground/70">{frontmatter.subtitle}</p> -->
      <slot />
    </article>

    <aside
      class="sticky top-16 hidden h-[calc(100vh-4rem)] overflow-y-auto lg:block"
    >
      <TreeNode tree={groups} />
    </aside>
  </div>
</Main>
